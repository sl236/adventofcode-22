#!/usr/bin/python
import fileinput, re, itertools, functools

rocks = [
    [4,
     0b1111],

    [3,
     0b010,
     0b111,
     0b010,],

    [3,
     0b111,
     0b001,
     0b001, ],

    [1,
     0b1,
     0b1,
     0b1,
     0b1,],

    [2,
     0b11,
     0b11,],
]

test = '>>><<><>><<<>><>>><<<>>><<<><<<>><>><<>>'
puzzle = '><<<<><<>><<>><><<<>>><<<<>>>><<>>><>>><<<>><<<><<<><><><>>>><<>>><<<<>>><>><<<<>><><<<<>>><<<>>><<>><<<>>><>>>><<<<>>>><<<<><>><<<>>><<<<>><<<<>>>><<<<>>><<>>><<<>>><>>><<<<>>><<<<>>>><>>>><<>>><<><<<>>>><><<<<>>>><>><<>><<<><<<<>><<><<<<>>><>><<><<<>>><<<>>><<><<<<>><>><<<><<<>>>><>>>><<<>><<<<>>>><<<>>>><><<<<>>>><<<<>>>><<<<><<<>>>><><<<>>><<<><<><<<>>><<<><<>>>><<<>>>><<<>>><<><>>><<><>>>><><><<>>><<<>><<<>><><>>><<<>>><<<<><>><>>>><<><<<>>>><<><<<<>>><><<>>>><<<<>>>><<><<<<>><<><><>>>><<>><<>><<<<><>>><><<<>><<<>><><>>>><<<>><<<<>>><<><>>>><>>>><<<>>><<<<>>><><<<<>>><>>>><>>><<>>>><<>><<>>><<>><><>><<<<>>><<><<>><<<<><<<>>>><>>><>>><<<>>><<<>>>><<>>><<<<>><<>>>><><<<><>><<<><<<<>>><><<<><<<<>><>><<<<><<<>><>>><<<<>>>><<>>>><<<<>>><><<<>>><<<<><>><<<>><<<<><>>><>>>><<>>><<<>>>><<>>><><<<><<<<><<><>>>><><>>>><<>>><<<<>><<<<><<>>><<><<<><<<<>>><><<<>>>><>>>><<<><<<>><<><<<>>>><<<<>><><<<<>>>><<>>>><<>><<>><<<>><<<<>><>>><<<<>>>><><<>>><<>>><>>><<<<>>><<<<>>><<>><>><<<>><<<>>>><<<>>>><<>><<<><><>>><<<<>><<>>>><<><><<<><>>>><<<>><<<>>>><<<<><<>>><<>>>><<><<<<>><<>>><<<<>><>>><<>>>><<<<><><>>><<<<>>>><>>>><<>>>><<<<><<>><<<><<<>><<<>>>><<<><<<<>><<<<>><<<<>>>><<<>>>><>><<<>>>><<<>>><<><><<<>><<<>><>>><>><><<<<>><<<<>>>><<<>>><>>><<><><<>>>><<<<><><<<>>>><<>><<>>><<<<>>>><>>>><>><<<>><<<<>>>><><<><<>>>><<<>><<>>><<<<>><<>>><<<<>>>><<<>>><<<><>><<><>>>><<>>>><<<><>>><>>>><<<<>>><<<>><<>>><<<<><<<>>><<>>><<<<>>><<>><<<><>>><><>>>><<>>>><<>><<<<><<<>>><<<<>><<<>><>><<<>><>>><<<>>>><>><><<>>><<>>><<<>>><<>><<<<>>>><<>><<>>><<>>><<>>><<>><><<<>>>><>>>><><<<>>><>>><<<<>>><<<<><>>>><<<<><<><<<>>>><<<>><<<><><<<<>>><<>>><<<<>>>><<>>><<<><<<<>>>><<<<>><<<><<>>><>><<>><<<<>><>>>><<>><<<>>><<<><<>>><<<><<<<><<<<><<>><>>>><>><>><<>>><<<<>>>><<<<>>><<<<><<<<><<<><>>><>>><<<<>><<>>>><><>>><>>>><><>>>><<<>><<>><<<<><>>>><<<><<<<><>>>><<>>><<<>>>><<>>>><<<<><<<<>>>><<><<<<>><<<>><>>><<<<><<>><<<>>><>><<<<>>>><<>>><<<>>><>><<<>>>><>><<<><<<<>>><<<<>><<>>><<<>>>><<<>>><><<><<<><<>>>><<>>><<>>>><>>>><<<<><><>>>><<<>>><<<>>>><<>><<<<><<<>>><<<>>>><>><<>>><<<>>>><>><><<<<>>>><>><<<<>>>><<<<>><>>>><<><<<<>><><<<>>><<<<><<<<><>><>>>><<<>>>><<<>><<>>>><>><<<>>><<<>>><<<<>>><<<<><<>><<<<>><>>><>>><<>>><<<><<<<>>>><<<>>><<>>><<<<>><><<<>>>><><<<<>>><<<>>><<<>><<>>>><<>>><<<<>>><<>>><>>>><<>><<<>>>><<<<>>>><<<<><<><><<>>>><<<<><<>>><<<<>>><<<<>><<><>>><>><<>>>><<<<>><<<>>><<<<>><<>><<><<>>><<<>><<<>>>><<>>><<<>>>><<<<>>><<<<>><<>>>><<<>>>><>><<<<>>><>>><<><<>>>><<<>>><>>><<<>><<<<><><<<>>><<<><<<>><<<<><<<>><<<<>>>><>><>><>>>><<<><<<>>><<<><<<<>>>><<>>>><<<>><<>><<<<>><>><<<><<<<>><<<>>>><<>>>><<>>>><>>>><<<<>>><<>>>><<>>>><<>><<<>>><>>>><<<<><>>>><<<<><>>>><<<>>>><<<<>>><<<<>><><<<<>>><><>><<<<>>><<<>>><><<<>>>><<<>>>><<><<<<><<<<><<><<<<>>><>>>><<>>>><<<>>>><<<>>><<<<>>><>><<<><<<<>>>><<<<>>><<<<>>>><<<<><<<>><<<>>>><<<><<<<><>><<<<>><><<<>>><>><<<>>><<>><<>>><>><>>><<>>><<<>>>><>><<<>><<>>><<<<>>>><>><><<>><>><<<<><><<>>><<<<>>>><<>>><<<<>>><<<<><>>><<<>>>><<<<>>><<<>>>><<<>><<><><<<<>>><<>>>><<>>><<><<<<>>>><>><<>><<<<>><>>><<<<>><<>>>><<<<>>><<>><>><>><><<<>>>><<<>>><<>><><<>>>><<<>>><<<>>>><<<<><<<>><>>><>>>><<<<><<<<>>>><<<>><<<<><<<<>>><<<<>>>><>>><<<<>>>><<<>><<<>><<<>>><<<<>>><<<>>>><>>><><<>>><>>>><<>>><<>>>><<<>><<<><<>>><<>>>><<<<>><><<<<><<<>><>>>><<<<>>>><<<<>>><<<<><><>>>><<>><>>><<>>>><<>>>><<<<>>><><<>>><<<<><<<><<>>><>>><>><>>>><>><<<>>>><<>>><<<>>><<>><<<<>>><<>>><<><<<<><<>>>><<<<><>>>><<<>><<><<<<><<><<>>>><<><<<<>>><<>>><>><>>><>>>><>>>><<>><<<<><<<<>>>><>>><<>>>><<<<>>><<><<<<>>><<<<>><>>>><>><<<<>>><<>><<<>><<>>><<<<>>>><<<>>>><>>>><>>>><<<<><>>><>>>><<<>><>><<><<<><<>>>><<<<>><<>>><<>>><<<<>><<<<><<<>>>><<<>><<>>>><<<>>>><<><><<<<>>>><><<>>><<>>>><<<>>><<>><<><<<><<<>>>><><<<>>><<<<>><>>>><<<><<><<<<>>>><<><<<<>>>><<<>><><<>>>><>>>><<<<><<<><<<>>>><<>><>>><<<>>>><<>>>><>><<<><<><<<<>>>><<>>>><<<>><<>><<<<><<>><<<>>>><<><<<>>><<<<>>><<<<><<>><<<>>>><>>>><<<<>>><>><<<<>>>><<<><<<<>>>><<<>>>><<><<<<>>>><<<<><<>>>><<><<><>>><>>><>>><>>>><<<<><<<<>>>><>><<<<>><<<<>>><<<<>>>><>><<<>>>><>>>><>>>><<>>>><>><<<>><><<>><<>>><>><><>>>><>>>><>>>><<<>><<><<<<>>>><><>>><><>><>><<>>><<>><<>>><<<<><<<>>><<<<>>>><<<<><<<>>><<<<>>>><<<<>>>><>>><><>><<<<>>>><<<<>><<><><<<><<>><<<<>><<<>><<<>>><<<>><<<>><><<>>>><<<<><<>>>><<><<<>><<<<>>><<<>>><<<>><>><<<<>><<<<><<<<>><<<<><>>><<<<>><<<<>>><<<<><<><>><<<>><>>>><>>>><>>>><<<<>><<<<><<>>><>>>><<<<>>><<<><<<>>><<<>><<><<>>><<<>>>><<<>>>><<<<>><>>>><<<<>>><>>><<>>>><<>>>><>>><<<><>>><<<><>>>><<<<>>><<<>><<<>>>><<<<>>>><<><><><<<><<>>>><<<<><<<>><<>><<<<>>><<>>><<<><<<>>>><<>><>>><>>><<<<><<<>>><<<><<<><<<>><<>>><<><<>>>><<<<>>><<<>>>><<>><<<<>>>><<><<<<><<>>><<<><>>>><<<><<>>>><>>><<>>><<<<>><<>>>><<<>>><<<>>>><<<<>>>><<<><<<>>><<<><<<>>><<<<><<>>>><>>>><<<>>>><>>><>>>><<<>><<<<><<<<><<<<>><<<<><<<<><>><<><<<<>>><<<<>>><<>>><<<>>>><<<>>>><<<>><<<>><<<><<<>>><<>>>><><<<>><<<>>><<>><<<<><<>>><>><<<>>>><<<<>>>><<>>><<>><<><<<<><<<>>>><<<<>>>><<>>><<>><<<>>><>>>><<<>><>>>><<>>>><<<<>><<<<>>>><<>><>>><><<><<>>>><<>><<><>>>><<>><<<<>>>><>>><><<<<>>><<<<>>>><<>>>><<>>>><<<<>><<<>>><<>>><>>>><<<><<<><<<>><>><><>>>><<>><<<<>><<<<>><><>><<>>>><<<><<<><>>><<<>>><<<>>>><<<>>><<<>>>><>>>><<<>><>>>><<<>>>><<<>>>><<<<><>>>><<<<>>>><>>><<<>>><<>><<><<<>>>><<<>>>><<<>><>><<<<>><<<>><<<>>><<<<><<<<>>>><<<<>>><<<<>><<<<>><<><>>><<<>>><<<<><<<>>><<<<><>>><<<>>>><>>>><><<<<>>>><><>><<>>>><>>><<<<>>><<<>><>><<<<><<<<>>><><<<<>>>><>><>><<<<>><<>><<<<>><<>>><<>>><<<>>>><<>>><<>><<<<>>><<>>>><<><<>><<<<>>><<<<><<<<><<<><>>><<>><<<<><<<>>>><>>>><><<<><<><<<<>><<<>><>>>><<<<>><<><<<><<<<>>>><<<><<>>>><><<><<<<><<<<>>><<<<>>>><<>>><<<><<<>>>><><<>>>><><<><<<<><<>>>><><<>><<>><>>><<><<<>><<>>>><<<<><<<<><><>>>><<<<>>><<<<>>><<>>>><<<><<<>><<<>>>><<<<><<<<>><<<<>>><<<<>>><>>><<<><<><<<<>>>><>><<>>><>><<<<>>><>>>><<>>>><<<<><<>>><<<<><<>><><<>>>><>><<>><<<<>><<>><<<<><<<<>>>><<<>><<>>><<><<<<>>>><<<>>>><<>>>><>>><<<>>><><<>><<>>><>>><>>>><<>>><<<>>>><><<<<><<>><<<<>>>><>><<<<><<<<><<<<>>>><<<><<<<>><<<>>>><<<<>><>>>><>><<<<>><>>><><<<>><><<<<>>><>>><<<>>>><<<>><<<<><<><<<><>>><>>>><<>>>><<<<>>><>>>><>>>><<>><<>>><<<<>>><<>>><<>>>><<<><<>>>><<<<>><>><<<>>><<<<>>>><>>><<<>>>><<<>><<>><<>>>><<<>>><<<>>>><>><<>><<<<><>>>><>><<>><>><>><>><<<>><<><>>>><>>><<<<>>><<<>><<<<>><<<<>><><<<<><<<<>><<<<>>><<>>>><><<<<>><<<<>><<<<>><>><>>><<><<>>><<<><<<>>><>>><><<<>>>><<<<><<<>>>><<>><>>><<><<>><<<>><<<<><<<<>>><>>><<><<>>>><<<><<><<<<>>>><<<<><<>><>>><<<<><<<>>>><<>><<<><<<>>><>>>><>>><<>>><>>><<<<>><>>>><<><>>>><<<><<><<<<>>><<<>>>><<><><<>><<<<><<>><<><<<<>><<><<><<<<>><>><<<>>><<><<<>>><<<<>>><>>><><><<>>>><<><<<<><>><>>>><<<<><<<<>>><<<<>>>><>><<<>><<<>><<<<>>><<>>><<<<>>>><<<<>><<>><<>><<<<>><>>>><<><>>>><<<>>>><<<>><>>>><<<>>><<>>><<>><><<<<>>><<>><<<<>><<<><<>>><<<>>>><<>>><<>>>><<<<>>>><>>><><<<<>>><<<>>><<<>><<>>><<<<><<<>><<<>><<><>>><<<<><<>><<<<>><<><<><>>>><>>><<>>>><<<<>>><<><<<>><<<>>>><<>>>><>>>><<>><<<>>><>>>><<>><<<>>>><<<>><<<<>>>><<<<><<>>><>>><<<><<>><>>><>>><<<>><<<<>><<<>>><>><<<>><<<<>>><<><><<<<>><<<><<<<>>><>>>><<<><<<<>><<<>><<><<<>>>><<<<>><>>><<<>><<>>><<<>><<<>>>><<<>>><<<<><<>><><<<>>><<<<>>>><<>>><>>>><<>>><<<<>>><>><<<>><>><<<<>><<<<><<>>><<><<>>>><<<><>>>><<<>>><<<>>><<>><<<<>>><<>>>><<<<>>><<><<<>><<>>>><<<<><<<<>>>><<<<>>><<<>><<>>><<<><>>><<>>><><>>>><<>><>><<<<>>>><<<>>><<<<>>>><>><<<<>><<>><<<>>><<<<>>><<<>>><<>><<<>>>><<>>><<>><<<><<<>>><<>>><<<>>>><<<<>><<<<>><<<>>><<<>>><<>>>><<<<>>>><<><<<<><>><>>>><<><<>>><<<<><<<<>>>><>>><<<><>><<>>><<<<>>><<>>>><<<>>>><>>>><<<>><><<>>><<><<<>><<>><>>><<<<>><>>>><<>><>>><<<<>><<>>>><<><<<<>>>><<<>>><>>><<<><>>><>><<<<><>>>><<<<><<<<>>><>>><><<>>><<>>><><<<<><<<><>><>>>><<<>>>><><>><><>><<<<><<<><<<>>>><<<>>><<>>><<<>><<<><<>>><>>>><<><<>>>><<<<>><<>><>>><<<<>>><<<>>>><<<<>><<<<>>>><<>><<<>><<<>><<<>>>><<<<>>>><>><<<<>>>><><><>>><>>><<<>>><>><<<<>>>><<><<<>>>><<>>><<<><<<<>><<<><>>><<>>><<<<>>>><><<<<>><<<>><<<>><<<>><<>>>><<<>>>><<<>>><<<><<<><<<><<<<><>><<>>><><<<><<<>>><<<<>>>><<<>>><>>><><<<>><<<>>>><<><><<<<>>>><<><<<>>>><<<>>>><<><<<<>>>><<<><<<>>>><<>>>><<><><<<<>>><<<><<<><><<>>>><<>>>><<<>>>><<>><<><>>>><<<<>>>><<<<>>><<<<>><<<><<><>><<<>>>><>><>><<<<><><><><<<<>>><<<<>><<>><>><<>><<<>>>><<<>>>><<<<>>>><<<>><<<>>>><<>>>><<<><<<>>><>>><<<>>><<<<>>><<<<>>><>>><<<<>>><<<<>>><<<>><<<<><<<>>><<<<>><<<><<<>>><<<<>><<>><<<<><<<<><><>>><<>><><<<<>>>><<>>><<<>><<><><>>><>>>><>>>><<<<>>><<<<>>>><<>>><<<<><<<<>>>><<>><<<>>><<>>>><<<>><<<<>><><<<<>>><<>><<<<>>><<<<>>><>>><>>><<<<>>><<<<>>>><>>>><<<<>>><><<><>>>><><<<<>>><>>>><<>>>><<><<<<>>><<<>>>><<<>>><<<<>><<<><<<<><<<<>><<<>>>><<<<>>><<<><<<<>>><<<<>>><<>>><<<>>>><>>>><<>>><<<><<<><<<<>><<<<>>>><<>>><<<>>>><<<>><<<<><<<>>>><<<<>><<<<><<><<<<>>><<<>>>><<<><>><<<>><>><<>>><<><<<><><<<>><<>>>><<><>><<<>>><<>>>><>>>><<<<>>><<>>>><<>>><<>><<<><<<<><>>><<><<><>>><<<<>>>><<<>>>><<>>>><<<<>>>><<<><<<<><>>><<>><<<><<>>><>>><<<>>><<>>><<>>>><<><<<<>>><>><>><<<><<<<>><<<<>>>><>>><<>>>><<<<>><<>>>><<><>><<<>><<<><<<>>>><<>><<<>>><<<<>>><>>><>>><<<<>>>><<<>><<<>><<<<><<<>><<<>>><<>><<<>><<>><<<>>><<<<><<>>>><<><>><<>>><<<>>>><><>>>><>>>><><<<<>>>><<>><<>><>>>><<>><<>><<<<>><<>><<<<>>>><>><<<<><><>><<>><<<<>>><<<<>><<<><<<>><<<><<<>><<<<>>>><>>><<<>>>><<<>>>><<<>>>><<>>>><<>><>>>><<<>>><<<<>><>>><<<>><>>><<<>>>><<<<><>><<<<><<>>>><<<>>>><<<<>>><>>><<<<><<>><>>><<<>>><>>>><<<>>><<<>><><>><<>>><<<>><<<>><>><<>>><<<>>><><>>><<<>>>><<><>>><<>>>><<<<>>>><<<<>><<<<><<>>>><<<>><<>>>><<>>><<>>><<>>><<><<<<><<<>>><<<><>>><<<<><<<>>>><<<>>>><<<<><<>>>><<<>><<<>>>><<<<>>>><<<<>>><>>><<><<<><<<>>><<<<>>>><<<<>>>><<><><<<<>>>><<>><<<<>>><<<>><>>><<<>>><>><<<>>><>><<<><<>><>>><<<>><<>><>><<>>><>><<<><<<>>><<<<>><<<<>>><>>>><<<<><<<<>>>><>>><><<<<>>><<<<>>>><>><<>>>><<<<>>><<<<>><><<>>>><<>>><<<<>><<<>>><<<><<<<>>>><>><<>>><<>>><>>><<>>><<>><<<<>><<>>>><<<<>><<>>><<>><<>>><>>><<<>>>><<<>>>><<<<>>><>><<<>>><<<><<>>>><><<<>>>><<>><<>>>><>>><<>>>><><<>>><<<><>><<<>><>>>><>>>><<<>><<>>>><>><<>>>><<>><<<<>>>><<<<><>>><>>>><<>><<><<<><<><<<<>>><<<<>>>><<>><<>>><><<<>><>>>><<<>>><><<><<<>>><<<<>>><>>><<><<><<>><>><<><<>>><<<<'

WIDTH = 7

def overlaps(tower, shape, x, y):
    if x < 0 or x + shape[0] > WIDTH:
        return True

    for row in shape[1:]:
        if y >= len(tower):
           return False
        row = row << x
        if( ( row & tower[y] ) != 0):
            return True
        y+=1
    return False

def place(tower, shape, x, y):
    top = len(tower)
    while y+len(shape)-1>len(tower):
        tower.append(0)

    for row in shape[1:]:
        tower[y] = tower[y] | (row<<x)
        y += 1

def dump(tower):
    for idx, row in enumerate(reversed(tower[1:])):
        s = '{:>5} |'.format(len(tower)-idx)
        for c in range(WIDTH-1,-1,-1):
            s += '#' if row & (1<<c) else '.'
        s += '|'
        print(s)
    print '+' + ('-' * WIDTH) + '+\n'

def drop(jets, count):
    tower = [(1<<WIDTH)-1]
    tick = 0
    states = {}
    skipped = 0

    rock = 0
    while rock < count:
        shape = rocks[rock % len(rocks)]
        x = WIDTH-shape[0]-2
        y = len(tower)+3

        while not overlaps(tower, shape, x, y):
            if y<0:
                raise RuntimeError()
            dx = 1 if jets[tick%len(jets)] == '<' else -1
            if not overlaps( tower, shape, x+dx, y):
                x += dx
            tick +=1
            y -= 1
        y += 1

        top = len(tower)
        place(tower, shape, x, y)
        newtop = len(tower)

        if skipped == 0 and (newtop - top == len(shape)-1):
            state = (rock%len(rocks), tick%len(jets), tower[top-1], tower[top])
            if state in states:
                oldtop, oldrock = states[state]
                clen = newtop - oldtop
                rcount = rock-oldrock
                skipped = ((count - rock) // rcount) * clen
                if skipped != 0:
                    print("\nCycle found at rock {}: dropping {} rocks increases tower at {} by {}.".format(
                        oldrock, rcount, oldtop, clen,
                    ))
                    print("Skipping {} rocks, {} height total; {} remain. Current rock {}, count now {}\n".format(
                        ((count - rock) // rcount),
                        skipped,
                        ((count-rock) % rcount),
                        rock,
                        rock + ((count-rock) % rcount)
                    ))
                    count = rock + ((count-rock) % rcount)
        states[state] = (len(tower), rock)
        rock += 1

    # dump(tower)
    return skipped+len(tower)-1

print("Part 1 test: {}\n".format(drop(test,2022)))
print("Part 1 puzzle: {}\n".format(drop(puzzle,2022)))

print("Part 2 test: {}\n".format(drop(test, 1000000000000)))
print("Part 2 puzzle: {}\n".format(drop(puzzle, 1000000000000)))
